<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A(k) vs k — Gaussian Momentum Distribution</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0f172a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            color: #e2e8f0;
            overflow: hidden;
            height: 100vh;
        }

        /* Top Title Bar */
        .title-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            display: flex;
            align-items: center;
            padding: 0 24px;
            z-index: 1002;
            gap: 12px;
        }
        .title-bar .title-text {
            font-size: 17px;
            font-weight: 700;
            color: #f1f5f9;
            letter-spacing: 0.3px;
        }
        .info-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1.5px solid rgba(148, 163, 184, 0.35);
            background: rgba(148, 163, 184, 0.08);
            color: #94a3b8;
            font-size: 14px;
            font-weight: 700;
            font-style: italic;
            font-family: Georgia, 'Times New Roman', serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .info-btn:hover {
            border-color: #60a5fa;
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        /* About Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-box {
            background: #1e293b;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 14px;
            padding: 28px 32px;
            max-width: 560px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-box h2 {
            font-size: 18px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 14px;
        }
        .modal-box p {
            font-size: 14px;
            color: #cbd5e1;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        .modal-box .equation-block {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 16px 0;
            text-align: center;
            overflow-x: auto;
        }
        .modal-close {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 22px;
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #60a5fa;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(96, 165, 250, 0.25);
        }

        /* Main canvas */
        #canvas-container {
            position: fixed;
            top: 52px;
            left: 0;
            right: 320px;
            bottom: 0;
        }
        canvas#mainCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Right Sidebar Panel */
        .right-panel {
            position: fixed;
            top: 52px;
            right: 0;
            width: 320px;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(14px);
            border-left: 1px solid rgba(148, 163, 184, 0.12);
            z-index: 1001;
            overflow-y: auto;
            padding: 0;
        }
        .right-panel::-webkit-scrollbar {
            width: 4px;
        }
        .right-panel::-webkit-scrollbar-thumb {
            background: rgba(148,163,184,0.2);
            border-radius: 2px;
        }

        /* Panel Sections */
        .panel-section {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        }
        .panel-section:last-child {
            border-bottom: none;
        }
        .panel-section h3 {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 14px;
        }

        /* Formula display in panel */
        .formula-display {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.08);
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #cbd5e1;
            text-align: center;
        }
        .formula-display .param {
            font-weight: 700;
            color: #60a5fa;
        }
        .formula-display .sigma-param {
            font-weight: 700;
            color: #34d399;
        }
        .formula-display .math {
            font-style: italic;
            color: #f1f5f9;
        }
        .param-values {
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 12px;
            color: #94a3b8;
            margin-top: 6px;
        }
        .param-values span {
            font-weight: 600;
        }

        /* Controls */
        .control-group {
            margin-bottom: 14px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        .control-group label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #cbd5e1;
            font-size: 13px;
        }
        .control-group .val {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: #f1f5f9;
            min-width: 55px;
            text-align: right;
        }
        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(148, 163, 184, 0.12);
            border-radius: 3px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transition: box-shadow 0.2s;
        }
        .slider::-webkit-slider-thumb:hover {
            box-shadow: 0 0 8px rgba(96,165,250,0.5);
        }
        .slider.k0-slider::-webkit-slider-thumb {
            background: #60a5fa;
        }
        .slider.sigma-slider::-webkit-slider-thumb {
            background: #34d399;
        }
        .slider.probe-slider::-webkit-slider-thumb {
            background: #f472b6;
        }

        /* Toggle rows */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .toggle-row input[type="checkbox"] {
            accent-color: #60a5fa;
            width: 14px;
            height: 14px;
        }
        .toggle-row label {
            cursor: pointer;
            font-size: 13px;
            color: #cbd5e1;
        }

        /* Annotations */
        .anno-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.05);
        }
        .anno-row:last-child { border-bottom: none; }
        .anno-label {
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        .anno-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .anno-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: #f1f5f9;
            font-size: 12px;
        }

        /* Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 0;
            font-size: 12px;
        }
        .legend-swatch {
            width: 22px;
            height: 9px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.08);
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <!-- Top Title Bar -->
    <div class="title-bar">
        <div class="title-text">A(k) vs k — Gaussian Momentum Distribution</div>
        <button class="info-btn" id="infoBtn" title="About this simulation">i</button>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <h2>About This Simulation</h2>
            <p>
                This interactive simulation visualizes the <strong>Gaussian momentum amplitude distribution A(k)</strong> 
                commonly encountered in quantum mechanics when describing wavepackets. The amplitude function governs 
                how momentum components are distributed around a central wavenumber k₀.
            </p>
            <p>
                Students can drag <strong>k₀</strong> to shift the peak (changing the particle's central momentum) and 
                adjust <strong>σ</strong> to widen or narrow the distribution. Shaded regions under the curve show the 
                fraction of momentum components within ±σ (68.27%) and ±2σ (95.45%) of the center, reinforcing that most 
                of the wavepacket's momentum content clusters near k₀. A draggable probe line displays A(k) at any point.
            </p>
            <p>
                Key annotations — peak location, FWHM, and the 1/e² width — update dynamically as parameters change.
            </p>
            <div class="equation-block" id="katexEquation"></div>
            <p style="font-size:12px; color:#64748b; margin-bottom:0;">
                where k₀ is the central wavenumber and σ characterizes the width of the distribution in k-space.
            </p>
            <button class="modal-close" id="modalClose">Close</button>
        </div>
    </div>

    <!-- Main Canvas -->
    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <!-- Right Sidebar Panel -->
    <div class="right-panel">

        <!-- Formula Section -->
        <div class="panel-section">
            <h3>Live Formula</h3>
            <div class="formula-display">
                <span class="math">A</span>(<span class="math">k</span>) = 
                <span style="color:#fbbf24">(2πσ²)</span><sup style="color:#fbbf24;font-size:10px">−1/4</sup>
                · exp[ −(<span class="math">k</span> − <span class="param">k₀</span>)² / (4<span class="sigma-param">σ²</span>) ]
            </div>
            <div class="param-values">
                <span class="param" style="color:#60a5fa;">k₀ = <span id="formulaK0Val">5.00</span></span>
                <span class="sigma-param" style="color:#34d399;">σ = <span id="formulaSigmaVal">1.00</span></span>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="panel-section">
            <h3>Parameters</h3>
            <div class="control-group">
                <label>Central Momentum k₀ <span class="val" id="k0Val" style="color:#60a5fa">5.00</span></label>
                <input type="range" class="slider k0-slider" id="k0Slider" min="-10" max="10" step="0.01" value="5">
            </div>
            <div class="control-group">
                <label>Width σ <span class="val" id="sigmaVal" style="color:#34d399">1.00</span></label>
                <input type="range" class="slider sigma-slider" id="sigmaSlider" min="0.2" max="4" step="0.01" value="1">
            </div>
            <div class="divider"></div>
            <div class="toggle-row">
                <input type="checkbox" id="probeToggle" checked>
                <label for="probeToggle" style="color:#f472b6;">Show Probe Line</label>
            </div>
            <div class="control-group">
                <label>Probe Position k <span class="val" id="probeVal" style="color:#f472b6">5.00</span></label>
                <input type="range" class="slider probe-slider" id="probeSlider" min="-10" max="10" step="0.01" value="5">
            </div>
            <div class="divider"></div>
            <div class="toggle-row">
                <input type="checkbox" id="shadingToggle" checked>
                <label for="shadingToggle">Show ±σ / ±2σ Shading</label>
            </div>
            <div class="toggle-row">
                <input type="checkbox" id="annotationsToggle" checked>
                <label for="annotationsToggle">Show Annotations</label>
            </div>
        </div>

        <!-- Annotations Section -->
        <div class="panel-section" id="annotationsPanel">
            <h3>Annotations</h3>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:#60a5fa"></span>Peak (k₀)</span>
                <span class="anno-value" id="annoPeak">5.00</span>
            </div>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:#fbbf24"></span>FWHM</span>
                <span class="anno-value" id="annoFWHM">2.355</span>
            </div>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:#a78bfa"></span>1/e² Width</span>
                <span class="anno-value" id="anno1e2">4.000</span>
            </div>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:rgba(52,211,153,0.5)"></span>±σ Content</span>
                <span class="anno-value" id="annoPm1Sigma">68.27%</span>
            </div>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:rgba(96,165,250,0.3)"></span>±2σ Content</span>
                <span class="anno-value" id="annoPm2Sigma">95.45%</span>
            </div>
            <div class="anno-row">
                <span class="anno-label"><span class="anno-dot" style="background:#f472b6"></span>A(k<sub>probe</sub>)</span>
                <span class="anno-value" id="annoProbe">—</span>
            </div>
        </div>

        <!-- Legend Section -->
        <div class="panel-section">
            <h3>Legend</h3>
            <div class="legend-item">
                <div class="legend-swatch" style="background: rgba(96,165,250,0.2); border: 1px solid rgba(96,165,250,0.4);"></div>
                <span style="color:#94a3b8">±2σ region (95.45%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch" style="background: rgba(52,211,153,0.3); border: 1px solid rgba(52,211,153,0.5);"></div>
                <span style="color:#94a3b8">±σ region (68.27%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch" style="background: #f472b6;"></div>
                <span style="color:#94a3b8">Probe line</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch" style="background: #f1f5f9;"></div>
                <span style="color:#94a3b8">A(k) curve</span>
            </div>
        </div>

    </div>

    <script>
    // Render KaTeX equation in the modal
    document.addEventListener('DOMContentLoaded', function() {
        const eqEl = document.getElementById('katexEquation');
        if (eqEl && typeof katex !== 'undefined') {
            katex.render(
                'A(k) = \\left(2\\pi\\sigma^2\\right)^{-1/4} \\exp\\!\\left[ -\\frac{(k - k_0)^2}{4\\sigma^2} \\right]',
                eqEl,
                { displayMode: true, throwOnError: false }
            );
        }
    });

    // Modal logic
    document.getElementById('infoBtn').addEventListener('click', function() {
        document.getElementById('modalOverlay').classList.add('active');
    });
    document.getElementById('modalClose').addEventListener('click', function() {
        document.getElementById('modalOverlay').classList.remove('active');
    });
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });

    (function() {
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');

        // Parameters
        let k0 = 5.0;
        let sigma = 1.0;
        let probeK = 5.0;
        let showProbe = true;
        let showShading = true;
        let showAnnotations = true;

        // Animation state
        let time = 0;
        let animPhase = 0;

        // DOM elements
        const k0Slider = document.getElementById('k0Slider');
        const sigmaSlider = document.getElementById('sigmaSlider');
        const probeSlider = document.getElementById('probeSlider');
        const k0ValEl = document.getElementById('k0Val');
        const sigmaValEl = document.getElementById('sigmaVal');
        const probeValEl = document.getElementById('probeVal');
        const formulaK0Val = document.getElementById('formulaK0Val');
        const formulaSigmaVal = document.getElementById('formulaSigmaVal');
        const probeToggle = document.getElementById('probeToggle');
        const shadingToggle = document.getElementById('shadingToggle');
        const annotationsToggle = document.getElementById('annotationsToggle');
        const annotationsPanel = document.getElementById('annotationsPanel');

        // Annotation elements
        const annoPeak = document.getElementById('annoPeak');
        const annoFWHM = document.getElementById('annoFWHM');
        const anno1e2 = document.getElementById('anno1e2');
        const annoPm1Sigma = document.getElementById('annoPm1Sigma');
        const annoPm2Sigma = document.getElementById('annoPm2Sigma');
        const annoProbe = document.getElementById('annoProbe');

        // Event listeners
        k0Slider.addEventListener('input', e => {
            k0 = parseFloat(e.target.value);
            k0ValEl.textContent = k0.toFixed(2);
            formulaK0Val.textContent = k0.toFixed(2);
        });
        sigmaSlider.addEventListener('input', e => {
            sigma = parseFloat(e.target.value);
            sigmaValEl.textContent = sigma.toFixed(2);
            formulaSigmaVal.textContent = sigma.toFixed(2);
        });
        probeSlider.addEventListener('input', e => {
            probeK = parseFloat(e.target.value);
            probeValEl.textContent = probeK.toFixed(2);
        });
        probeToggle.addEventListener('change', e => { showProbe = e.target.checked; });
        shadingToggle.addEventListener('change', e => { showShading = e.target.checked; });
        annotationsToggle.addEventListener('change', e => {
            showAnnotations = e.target.checked;
            annotationsPanel.style.display = showAnnotations ? 'block' : 'none';
        });

        // Gaussian function A(k)
        function gaussian(k, k0, sigma) {
            const norm = Math.pow(2 * Math.PI * sigma * sigma, -0.25);
            const exponent = -(k - k0) * (k - k0) / (4 * sigma * sigma);
            return norm * Math.exp(exponent);
        }

        // Coordinate transforms
        let plotLeft, plotRight, plotTop, plotBottom, plotWidth, plotHeight;
        let kMin, kMax, aMax;

        function resize() {
            const container = document.getElementById('canvas-container');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = container.clientWidth * dpr;
            canvas.height = container.clientHeight * dpr;
            canvas.style.width = container.clientWidth + 'px';
            canvas.style.height = container.clientHeight + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        window.addEventListener('resize', resize);
        resize();

        function kToX(k) {
            return plotLeft + (k - kMin) / (kMax - kMin) * plotWidth;
        }
        function aToY(a) {
            return plotBottom - (a / aMax) * plotHeight;
        }
        function xToK(x) {
            return kMin + (x - plotLeft) / plotWidth * (kMax - kMin);
        }

        // Mouse/touch interaction for probe
        let draggingProbe = false;
        canvas.addEventListener('mousedown', e => {
            if (!showProbe) return;
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const probeX = kToX(probeK);
            if (Math.abs(mx - probeX) < 12) {
                draggingProbe = true;
            }
        });
        canvas.addEventListener('mousemove', e => {
            if (!draggingProbe) return;
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            probeK = Math.max(kMin, Math.min(kMax, xToK(mx)));
            probeSlider.value = probeK;
            probeValEl.textContent = probeK.toFixed(2);
        });
        canvas.addEventListener('mouseup', () => { draggingProbe = false; });
        canvas.addEventListener('mouseleave', () => { draggingProbe = false; });

        function drawGrid() {
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.08)';
            ctx.lineWidth = 1;

            const kStep = kMax - kMin > 20 ? 5 : (kMax - kMin > 10 ? 2 : 1);
            for (let k = Math.ceil(kMin / kStep) * kStep; k <= kMax; k += kStep) {
                const x = kToX(k);
                ctx.beginPath();
                ctx.moveTo(x, plotTop);
                ctx.lineTo(x, plotBottom);
                ctx.stroke();
            }

            const aStep = aMax > 2 ? 0.5 : (aMax > 1 ? 0.2 : 0.1);
            for (let a = 0; a <= aMax; a += aStep) {
                const y = aToY(a);
                ctx.beginPath();
                ctx.moveTo(plotLeft, y);
                ctx.lineTo(plotLeft + plotWidth, y);
                ctx.stroke();
            }
        }

        function drawAxes() {
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
            ctx.lineWidth = 1.5;

            // k-axis
            ctx.beginPath();
            ctx.moveTo(plotLeft, plotBottom);
            ctx.lineTo(plotLeft + plotWidth, plotBottom);
            ctx.stroke();

            // A(k)-axis
            ctx.beginPath();
            ctx.moveTo(plotLeft, plotBottom);
            ctx.lineTo(plotLeft, plotTop);
            ctx.stroke();

            // Tick labels
            ctx.fillStyle = '#94a3b8';
            ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const kStep = kMax - kMin > 20 ? 5 : (kMax - kMin > 10 ? 2 : 1);
            for (let k = Math.ceil(kMin / kStep) * kStep; k <= kMax; k += kStep) {
                const x = kToX(k);
                ctx.fillText(k.toFixed(0), x, plotBottom + 6);
                ctx.beginPath();
                ctx.moveTo(x, plotBottom);
                ctx.lineTo(x, plotBottom + 4);
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                ctx.stroke();
            }

            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            const aStep = aMax > 2 ? 0.5 : (aMax > 1 ? 0.2 : 0.1);
            for (let a = aStep; a <= aMax; a += aStep) {
                const y = aToY(a);
                ctx.fillText(a.toFixed(2), plotLeft - 8, y);
                ctx.beginPath();
                ctx.moveTo(plotLeft - 4, y);
                ctx.lineTo(plotLeft, y);
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                ctx.stroke();
            }

            // Axis labels
            ctx.fillStyle = '#cbd5e1';
            ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('k (wavenumber)', plotLeft + plotWidth / 2, plotBottom + 28);

            ctx.save();
            ctx.translate(plotLeft - 46, plotTop + plotHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('A(k)', 0, 0);
            ctx.restore();
        }

        function drawShadedRegions() {
            if (!showShading) return;

            // ±2σ region
            ctx.beginPath();
            const k2Low = k0 - 2 * sigma;
            const k2High = k0 + 2 * sigma;
            const steps = 300;
            for (let i = 0; i <= steps; i++) {
                const k = k2Low + (k2High - k2Low) * i / steps;
                const a = gaussian(k, k0, sigma);
                const x = kToX(k);
                const y = aToY(a);
                if (i === 0) ctx.moveTo(x, plotBottom);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(kToX(k2High), plotBottom);
            ctx.closePath();
            ctx.fillStyle = 'rgba(96, 165, 250, 0.12)';
            ctx.fill();

            // ±σ region
            ctx.beginPath();
            const k1Low = k0 - sigma;
            const k1High = k0 + sigma;
            for (let i = 0; i <= steps; i++) {
                const k = k1Low + (k1High - k1Low) * i / steps;
                const a = gaussian(k, k0, sigma);
                const x = kToX(k);
                const y = aToY(a);
                if (i === 0) ctx.moveTo(x, plotBottom);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(kToX(k1High), plotBottom);
            ctx.closePath();
            ctx.fillStyle = 'rgba(52, 211, 153, 0.18)';
            ctx.fill();
        }

        function drawGaussianCurve() {
            const steps = 600;
            ctx.beginPath();
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 2.5;
            ctx.shadowColor = 'rgba(96, 165, 250, 0.4)';
            ctx.shadowBlur = 8;

            for (let i = 0; i <= steps; i++) {
                const k = kMin + (kMax - kMin) * i / steps;
                const a = gaussian(k, k0, sigma);
                const x = kToX(k);
                const y = aToY(a);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawAnnotationMarkers() {
            if (!showAnnotations) return;

            const peakA = gaussian(k0, k0, sigma);
            const peakX = kToX(k0);
            const peakY = aToY(peakA);

            // Peak marker
            ctx.beginPath();
            ctx.setLineDash([4, 4]);
            ctx.strokeStyle = 'rgba(96, 165, 250, 0.6)';
            ctx.lineWidth = 1.5;
            ctx.moveTo(peakX, plotBottom);
            ctx.lineTo(peakX, peakY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Peak dot
            ctx.beginPath();
            ctx.arc(peakX, peakY, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#60a5fa';
            ctx.fill();
            ctx.strokeStyle = '#1e3a5f';
            ctx.lineWidth = 2;
            ctx.stroke();

            // k₀ label
            ctx.fillStyle = '#60a5fa';
            ctx.font = 'bold 12px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('k₀=' + k0.toFixed(2), peakX, peakY - 14);

            // FWHM
            const fwhmActual = 4 * sigma * Math.sqrt(Math.log(2));
            const halfMaxA = peakA / 2;
            const kFwhmLeft = k0 - fwhmActual / 2;
            const kFwhmRight = k0 + fwhmActual / 2;
            const yHalf = aToY(halfMaxA);

            ctx.beginPath();
            ctx.strokeStyle = '#fbbf24';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([6, 3]);
            const xFwhmLeft = kToX(kFwhmLeft);
            const xFwhmRight = kToX(kFwhmRight);
            ctx.moveTo(xFwhmLeft, yHalf);
            ctx.lineTo(xFwhmRight, yHalf);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.arc(xFwhmLeft, yHalf, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#fbbf24';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(xFwhmRight, yHalf, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#fbbf24';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('FWHM', (xFwhmLeft + xFwhmRight) / 2, yHalf - 8);

            // 1/e² width
            const w1e2 = 2 * 2 * Math.sqrt(2) * sigma;
            const a1e2 = peakA * Math.exp(-2);
            const y1e2 = aToY(a1e2);
            const k1e2Left = k0 - w1e2 / 2;
            const k1e2Right = k0 + w1e2 / 2;
            const x1e2Left = kToX(k1e2Left);
            const x1e2Right = kToX(k1e2Right);

            if (x1e2Left >= plotLeft && x1e2Right <= plotLeft + plotWidth) {
                ctx.beginPath();
                ctx.strokeStyle = '#a78bfa';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([3, 5]);
                ctx.moveTo(x1e2Left, y1e2);
                ctx.lineTo(x1e2Right, y1e2);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.beginPath();
                ctx.arc(x1e2Left, y1e2, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#a78bfa';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x1e2Right, y1e2, 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#a78bfa';
                ctx.font = '11px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('1/e²', (x1e2Left + x1e2Right) / 2, y1e2 - 8);
            }

            // ±σ boundary dashes
            ctx.setLineDash([2, 6]);
            ctx.strokeStyle = 'rgba(52, 211, 153, 0.4)';
            ctx.lineWidth = 1;
            [k0 - sigma, k0 + sigma].forEach(kv => {
                const x = kToX(kv);
                if (x >= plotLeft && x <= plotLeft + plotWidth) {
                    ctx.beginPath();
                    ctx.moveTo(x, plotBottom);
                    ctx.lineTo(x, aToY(gaussian(kv, k0, sigma)));
                    ctx.stroke();
                }
            });

            // ±2σ boundary dashes
            ctx.strokeStyle = 'rgba(96, 165, 250, 0.3)';
            [k0 - 2 * sigma, k0 + 2 * sigma].forEach(kv => {
                const x = kToX(kv);
                if (x >= plotLeft && x <= plotLeft + plotWidth) {
                    ctx.beginPath();
                    ctx.moveTo(x, plotBottom);
                    ctx.lineTo(x, aToY(gaussian(kv, k0, sigma)));
                    ctx.stroke();
                }
            });
            ctx.setLineDash([]);

            // Update annotation values
            annoPeak.textContent = k0.toFixed(2);
            annoFWHM.textContent = fwhmActual.toFixed(3);
            anno1e2.textContent = w1e2.toFixed(3);
            annoPm1Sigma.textContent = '68.27%';
            annoPm2Sigma.textContent = '95.45%';
        }

        function drawProbeLine() {
            if (!showProbe) {
                annoProbe.textContent = '—';
                return;
            }

            const probeX = kToX(probeK);
            const probeA = gaussian(probeK, k0, sigma);
            const probeY = aToY(probeA);

            // Vertical probe line
            ctx.beginPath();
            ctx.strokeStyle = '#f472b6';
            ctx.lineWidth = 2;
            ctx.setLineDash([]);
            ctx.moveTo(probeX, plotBottom);
            ctx.lineTo(probeX, plotTop);
            ctx.globalAlpha = 0.5;
            ctx.stroke();
            ctx.globalAlpha = 1;

            // Intersection point
            if (probeA > 0.0001) {
                ctx.beginPath();
                ctx.arc(probeX, probeY, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#f472b6';
                ctx.globalAlpha = 0.3;
                ctx.fill();
                ctx.globalAlpha = 1;

                ctx.beginPath();
                ctx.arc(probeX, probeY, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#f472b6';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // Value tooltip
                const tooltipX = probeX + 12;
                const tooltipY = probeY - 10;
                const text = 'A(' + probeK.toFixed(2) + ') = ' + probeA.toFixed(4);
                ctx.font = 'bold 11px -apple-system, sans-serif';
                const tw = ctx.measureText(text).width;

                const tx = tooltipX + tw + 12 > plotLeft + plotWidth ? probeX - tw - 20 : tooltipX;

                ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
                ctx.strokeStyle = 'rgba(244, 114, 182, 0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.roundRect(tx - 6, tooltipY - 14, tw + 12, 22, 4);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#f472b6';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, tx, tooltipY - 3);
            }

            annoProbe.textContent = probeA.toFixed(4);
        }

        function drawGlowingParticles() {
            const numParticles = 20;
            for (let i = 0; i < numParticles; i++) {
                const phase = animPhase + i * (Math.PI * 2 / numParticles);
                const t = (Math.sin(phase) + 1) / 2;
                const kRange = 6 * sigma;
                const pk = k0 - kRange + t * 2 * kRange;
                const pa = gaussian(pk, k0, sigma);
                const px = kToX(pk);
                const py = aToY(pa);

                if (px < plotLeft || px > plotLeft + plotWidth) continue;
                if (pa < 0.001) continue;

                const alpha = Math.max(0.1, pa / gaussian(k0, k0, sigma)) * 0.6;
                ctx.beginPath();
                ctx.arc(px, py, 2.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(241, 245, 249, ${alpha})`;
                ctx.fill();

                ctx.beginPath();
                ctx.arc(px, py, 6, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(96, 165, 250, ${alpha * 0.3})`;
                ctx.fill();
            }
        }

        function drawPeakPulse() {
            const peakA = gaussian(k0, k0, sigma);
            const peakX = kToX(k0);
            const peakY = aToY(peakA);

            const pulseRadius = 8 + 4 * Math.sin(animPhase * 2);
            const pulseAlpha = 0.15 + 0.1 * Math.sin(animPhase * 2);

            ctx.beginPath();
            ctx.arc(peakX, peakY, pulseRadius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(96, 165, 250, ${pulseAlpha})`;
            ctx.fill();
        }

        function draw() {
            const container = document.getElementById('canvas-container');
            const w = container.clientWidth;
            const h = container.clientHeight;

            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, w, h);

            // Plot margins
            const marginLeft = 70;
            const marginRight = 30;
            const marginTop = 30;
            const marginBottom = 60;

            plotLeft = marginLeft;
            plotRight = w - marginRight;
            plotTop = marginTop;
            plotBottom = h - marginBottom;
            plotWidth = plotRight - plotLeft;
            plotHeight = plotBottom - plotTop;

            if (plotWidth < 100 || plotHeight < 100) return;

            // Dynamic range
            const range = Math.max(6 * sigma, 4);
            kMin = k0 - range - 2;
            kMax = k0 + range + 2;

            const peakA = gaussian(k0, k0, sigma);
            aMax = peakA * 1.15;

            // Draw elements in order
            drawGrid();
            drawShadedRegions();
            drawGaussianCurve();
            drawPeakPulse();
            drawGlowingParticles();
            drawAnnotationMarkers();
            drawProbeLine();
            drawAxes();

            // Title in plot area
            ctx.fillStyle = 'rgba(148, 163, 184, 0.5)';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            ctx.fillText('Gaussian Momentum Distribution A(k)', plotLeft + plotWidth - 4, plotTop + 6);
        }

        let lastTime = 0;
        function animate(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            time += dt;
            animPhase += dt * 1.5;

            draw();
            requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
    })();
    </script>
</body>
</html>